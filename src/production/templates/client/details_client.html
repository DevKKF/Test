{% extends 'client/menu_client.html' %}
{% load my_filters %}
{% load i18n %}
{% block extrastyle %}
  <style type="text/css">
    .vl {
       border-left: 2px solid var(--colorPrimary);
       height: auto;
    }
    .o-primary {
      color: var(--colorPrimary);
    }

    .o-bg-primary {
      background-color: var(--colorPrimary);
      color: #fff;
    }

    .info-box{
        cursor:pointer;
    }

    .info-box .collapsed{
        background: white;
        color:var(--colorPrimary);
    }

    .info-box-icon{
        background: var(--colorPrimary);
        color:white;
    }

    .info-box .collapsed .info-box-icon{
        background: var(--colorPrimary);
        color:white;
    }

    .info-box .collapsed .info-box-icon i{
        color:white;
    }

    .info-box:not(.collapsed) .info-box-icon{
        background: var(--colorAccent);
    }


    .info-box.active .info-box-icon{
        background: var(--colorAccent);
    }

    .tab-pane{
        overflow-x: hidden;
    }

  </style>
{% endblock %}
{% block content_title %}
    <div class="row mb-2">
          <div class="col-sm-6">
                <h1 class="m-0">Fiche client</h1>
          </div>
          <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                      <li class="breadcrumb-item"><a href="{% url 'admin:index' %}">{% trans 'Home' %}</a></li>
                      <li class="breadcrumb-item">Production</li>
                      <li class="breadcrumb-item"><a href="{% url 'clients' %}">Clients</a></li>
                      <li class="breadcrumb-item active">Fiche client</li>
                </ol>
          </div>
    </div>
{% endblock %}
{% block content %}

<!--div class="col-md-12" class="accordion" id="accordionClient_removed">
  <div class="card offset" style="padding:0px;margin:0px;border:none;">
    <div class="card-header">
      <h3 class="card-title text-white">DÉTAILS D'UN CLIENT</h3>
      <div class="card-tools">
        <span style="cursor:pointer;" class="btn btn-tool btn_modifier_client" data-client_id="{{ client.id }}" data-model_name="client" data-modal_title="MODIFICATION D'UN CLIENT" data-href="{% url 'modifier_client' client.id %}"><i class="fas fa-edit text-warning"></i></span>&nbsp;
        <button
          type="button"
          class="btn btn-tool"
          data-card-widget="collapse"
          title="Collapse">
          <i class="fas fa-minus"></i>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="row"-->
        <div class="col-12 col-md-12 order-2 order-md-1" id="accordionClient">
          <div class="row">

            <!--<div class="col-12 col-sm-4 col-md-2">

                  <div class="info-box collapsed active" data-toggle="collapse0" id="btnInfosClient" href="#collapseInfosClient" aria-expanded="true">
                      <span class="info-box-icon text-white elevation-1"><i class="fas fa-user-tag"></i></span></span>
                      <div class="info-box-content">
                        <span class="info-box-text">{{_('FICHE_CLIENT')}}</span>
                      </div>
                  </div>

            </div>

            <div class="col-12 col-sm-4 col-md-2">

                  <div class="info-box collapsed" data-toggle="collapse0" id="btnPolices" href="#collapsePolices">
                      <span class="info-box-icon text-white elevation-1"><i class="fas fa-file-contract"></i></span></span>
                      <div class="info-box-content">
                        <span class="info-box-text">{{_('POLICES')}}</span>
                      </div>
                  </div>

            </div>

            <div class="col-12 col-sm-4 col-md-2">

                  <div class="info-box collapsed" data-toggle="collapse0" id="btnContacts" href="#collapseContacts">
                      <span class="info-box-icon text-white elevation-1"><i class="fas fa-phone-alt"></i></span></span>
                      <div class="info-box-content">
                        <span class="info-box-text">{{_('CONTACTS')}}</span>
                      </div>
                  </div>

            </div>

            <div class="col-12 col-sm-4 col-md-2">

                <div class="info-box collapsed" data-toggle="collapse0" id="btnFiliales" href="#collapseFiliales" aria-expanded="true">
                    <span class="info-box-icon text-white elevation-1"><i class="fas fa-users"></i
                    ></span>
                    <div class="info-box-content">
                      <span class="info-box-text">{{_('FILIALES')}}</span>
                    </div>
                  </div>

            </div>


            <div class="col-12 col-sm-4 col-md-2">

                <div class="info-box collapsed" data-toggle="collapse0" id="btnGed" href="#collapseGed" aria-expanded="true">
                    <span class="info-box-icon text-white elevation-1"><i class="far fa-file-alt"></i></span></span>
                    <div class="info-box-content">
                      <span class="info-box-text">{{_('GED')}}</span>
                    </div>
                </div>

            </div>

            <div class="col-12 col-sm-4 col-md-2">

                  <div class="info-box collapsed" data-toggle="collapse0" id="btnAcomptes" href="#collapseAcomptes" aria-expanded="true">
                      <span class="info-box-icon text-white elevation-1"><i class="fas fa-funnel-dollar"></i></span></span>
                      <div class="info-box-content">
                        <span class="info-box-text">{{_('ACOMPTES')}}</span>
                      </div>
                  </div>

            </div> -->

            <div class="clearfix hidden-md-up"></div>


          </div>

          <!-- INFORMATIONS CLIENT  -->
          <div class="row collapse show" id="collapseInfosClient">
            <div class="col-12 col-sm-6 col-md-12">
              <h4></h4>
              <div class="card shadow_OLD">
                <div class="card-header">
                    <h3 class="card-title">{{_("FICHE DU CLIENT")}}</h3>
                    <div class="card-tools">
                        <!--span style="cursor:pointer;" class="btn btn-sm btn-primary btn_modifier_client" data-client_id="{{ client.id }}" data-model_name="client" data-modal_title="MODIFICATION D'UN CLIENT" data-href="{% url 'modifier_client' client.id %}"><i class="fas fa-edit"></i> {{_("Modifier client")}}</span>&nbsp;
                        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse"><i class="fas fa-minus"></i></button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button-->
                    </div>
                </div>

                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="button-link pull-right mb-2">
                              <span style="cursor:pointer;" class="btn btn-sm btn-warning btn_modifier_client mb-1" data-client_id="{{ client.id }}" data-model_name="client" data-modal_title="MODIFICATION D'UN CLIENT" data-href="{% url 'modifier_client' client.id %}"><i class="fas fa-edit"></i> {{_("Modifier client")}}</span>&nbsp;
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Nom complet")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control" title="{{ client.nom|default_if_none:'' }} {{ client.prenoms|default_if_none:'' }}">{{ client.nom|default_if_none:"" }} {{ client.prenoms|default_if_none:"" }}</span>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Code client")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.code|default:client.code_provisoire|default:"" }}</span>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Type personne")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.type_personne|default_if_none:"" }}</span>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Type client")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.type_client|default_if_none:"" }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="vl"></div>
                        <div class="col-md-5">
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Date de nais./création")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.date_naissance|default_if_none:""  }}</span>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Secteur activité")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.secteur_activite.libelle|default_if_none:""  }}</span>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Business unit")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.business_unit.libelle|default_if_none:"" }}</span>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-5 col-form-label">{{_("Date d'enregistrement")}}</label>
                                <div class="col-sm-7">
                                <span class="form-control">{{ client.created_at|date:'d/m/Y à H:i:s'|default_if_none:""  }}</span>
                                </div>
                            </div>
                        </div>
                </div>
                <hr>
                <h6 class="o-primary">{{_("COORDONNEES & AUTRES")}}</h6>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_('Pays')}}</label>
                            <div class="col-sm-7">
                            <span class="form-control">{{ client.pays|default_if_none:"" }}</span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_('Ville')}}</label>
                            <div class="col-sm-7">
                            <span class="form-control">{{ client.ville|default_if_none:"" }}</span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_('Adresse')}}</label>
                            <div class="col-sm-7">
                            <span class="form-control" title="{{ client.adresse|default_if_none:'' }}">{{ client.adresse|default_if_none:""|slice:":37" }}</span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_("Code postal")}}</label>
                            <div class="col-sm-7">
                            <span class="form-control">{{ client.adresse_postale|default_if_none:""|slice:":120" }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="vl"></div>
                    <div class="col-md-5">
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_("Tel fixe")}}</label>
                            <div class="col-sm-7">
                            <span class="form-control">{{ client.telephone_fixe|default_if_none:"" }}</span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_("Tel mobile")}}</label>
                            <div class="col-sm-7">
                            <span class="form-control">{{ client.telephone_mobile|default_if_none:"" }}</span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_("E-mail")}}</label>
                            <div class="col-sm-7">
                            <span class="form-control">{{ client.email|default_if_none:"" }}</span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-6 col-form-label">{{_("Logo")}}</label>
                            <div class="col-sm-6">
                                {% if client.logo %}
                                    <a href="{{request.scheme}}://{{request.META.HTTP_HOST}}{{client.logo.url}}" target="_blank">
                                        <img style="width:50px;" src="{{request.scheme}}://{{request.META.HTTP_HOST}}{{client.logo.url}}" alt="" srcset="" class="logo-partenaire">
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <h6 class="o-primary">{{_("RESEAUX SOCIAUX")}}</h6>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_("Site web")}} </label>
                            <div class="col-sm-7">
                            <span class="form-control"><a href="https://{{client.site_web}}" target="_blank"> {{ client.site_web|default_if_none:"" }}</a></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_('Facebook')}}</label>
                            <div class="col-sm-7">
                            <span class="form-control"><a href="https://{{client.facebook}}" target="_blank">{{ client.facebook|default_if_none:"" }}</a></span>
                            </div>
                        </div>
                    </div>
                    <div class="vl"></div>
                    <div class="col-md-5">
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_('Twitter')}}</label>
                            <div class="col-sm-7">
                            <span class="form-control"><a href="https://{{client.twitter}}" target="_blank">{{ client.twitter|default_if_none:"" }}</a></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-5 col-form-label">{{_('Instagram')}}</label>
                            <div class="col-sm-7">
                            <span class="form-control"><a href="https://{{client.instagram}}" target="_blank">{{ client.instagram|default_if_none:"" }}</a></span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
          </div>
        </div>
        <!-- FIN INFORMATIONS CLIENT  -->
      </div>
    <!--/div>
  </div>
</div>
</div-->

<div id="dialogBox"></div>

{% endblock %}


{% block extrajs %}

<script>
// GESTION TRANSFERT BENEFICIAIRES

  $(document).ready(function() {
      dataTable = $('#datatable_transfert_beneficiaires').DataTable({
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/French.json"
            },
            "serverSide": true,
            "ajax": {
                "url": "{% url 'transfert_beneficiaires_datatable' client.id %}",
                "data": function (data) {
                    console.log(data);
                    data.page = data.start / data.length + 1;
                    data.search_police_origine = $('#search_police_origine').val();
                    data.search_formule_origine = $('#search_formule_origine').val();
                    data.search_police_destination = $('#police_destination').val();
                    data.search_etat_beneficiaire = $('#search_etat_beneficiaire').val();
                },
                "dataSrc": function (json) {
                    return json.data;
                }
            },
            "columns": [
                {"data": "checkbox", "orderable": false, "searchable": false},
                {"data": "aliment__cartes__numero", "orderable": false},
                {"data": "aliment__nom", "orderable": false},
                {"data": "aliment__prenoms", "orderable": false},
                {"data": "aliment__date_naissance", "orderable": false},
                {"data": "aliment__genre", "orderable": false},
                {"data": "aliment__qualite_beneficiaire__libelle", "orderable": false},
                //{"data": "aliment__matricule_cie", "orderable": false},
                {"data": "aliment__adherent_principal__numero_famille", "orderable": false},
                {"data": "aliment__formule__libelle", "orderable": false},
                {"data": "aliment__statut", "orderable": false},
            ],
            "paging": true,
            "pageLength": 50,
            lengthMenu: [[50, 100, 500, 1000, -1], [50, 100, 500, 1000, "Tout"]],
            "processing": true,  // Show the loading indicator
            "searching": true,   // Enable the search feature
        });


        dataTable.on('xhr.dt', function (e, settings, json, xhr) {
            // Hide the spinner when the data is loaded
            $('.spinner-border').hide();
        });

        // Show the spinner when the table is processing
        dataTable.on('processing.dt', function (e, settings, processing) {
            if (processing) {
                $('.spinner-border').show();
            }
        });

        // dataTable.search('').draw();
        // dataTable.draw();

        // Add custom search functionality for code, name, and prenoms columns

        $('#search_police_origine, #search_formule_origine, #search_etat_beneficiaire, #police_destination').on('keyup change', function() {
            dataTable.search('').draw();
            dataTable.draw();
            $('#btnSelectAll').prop('checked', false);
        });

        $('#search_police_origine').on('change', function() {

            police_id = $(this).val();
            $('#search_formule_origine').html('').append('<option value="">Choisir</option>');
            $('#police_destination').html('').append('<option value="">Choisir</option>');

            //charger les formules
            $.ajax({
                type: 'get',
                url: '/production/formules_by_police/' + police_id,
                dataType:'json',
                success: function(formules){

                    formules.forEach(function(formule) {
                        $('#search_formule_origine').append('<option value="'+formule.pk+'">'+formule.fields.libelle+'</option>');
                    });
                },
                error: function(){
                    console.log('Erreur lors du chargement des formules ');
                }
            });

            //charger les formules
            $.ajax({
                type: 'get',
                url: '/production/polices_restantes/' + police_id,
                dataType:'json',
                success: function(polices){

                    polices.forEach(function(police) {
                        $('#police_destination').append('<option value="'+police.pk+'">'+police.fields.numero+'</option>');
                    });
                },
                error: function(){
                    console.log('Erreur lors du chargement des formules ');
                }
            });

        });


        $('#police_destination').on('change', function() {
            police_id = $(this).val();
            $('#formule_destination').html('').append('<option value="">Choisir</option>');

            //charger les formules
            $.ajax({
                type: 'get',
                url: '/production/formules_by_police/' + police_id,
                dataType:'json',
                success: function(formules){

                    formules.forEach(function(formule) {
                        $('#formule_destination').append('<option value="'+formule.pk+'">'+formule.fields.libelle+'</option>');
                    });
                },
                error: function(){
                    console.log('Erreur lors du chargement des formules ');
                }
            });

        });



       // Gérer le "Sélectionner tout"
        $('#btnSelectAll').on('change', function() {
           // Mettre à jour le tableau des éléments sélectionnés
           if (this.checked) {

                $('input[type="checkbox"]', dataTable.rows().nodes()).prop('checked', true);

           } else {

               // Cocher/décocher toutes les cases individuelles
               $('input[type="checkbox"]', dataTable.rows().nodes()).prop('checked', false);
           }

       });

        // Décocher le checkbox btnSelectAll si un des éléments est désélectionné
        $('#datatable_transfert_beneficiaires tbody').on('change', 'input[type="checkbox"]', function () {
            var data = dataTable.row($(this).closest('tr')).data();
            var itemId = data.id;
            console.log('itemId', itemId);

            if (!this.checked) {
                $('#btnSelectAll').prop('checked', false);
            }

        });

        // Transférer les bénéficiaires sélectionnés
        $('#btnTransfererBeneficiaireSelectionnes').on('click', function () {
            let ceBouton = $(this);
            let href = $(this).data('href');
            let police_origine_id = $("#search_police_origine").val();
            let formule_origine_id = $("#search_formule_origine").val();
            let police_destination_id = $("#police_destination").val();
            let formule_destination_id = $("#formule_destination").val();

            var selected_aliment_ids = [];
            var checkedCheckboxes = $('input[type="checkbox"]:checked', dataTable.rows().nodes());

            console.log("Nombre de lignes cochées : ", checkedCheckboxes.length);

            checkedCheckboxes.each(function() {
                selected_aliment_id = $(this).val();
                selected_aliment_ids.push(selected_aliment_id);

                console.log("selected_aliment_id : ", selected_aliment_ids);
            });


            if(checkedCheckboxes.length > 0){

                 $.ajax({
                    type:'post',
                    url:href,
                    data: {
                        police_origine_id: police_origine_id,
                        formule_origine_id: formule_origine_id,
                        police_destination_id: police_destination_id,
                        formule_destination_id: formule_destination_id,
                        selectedItems: JSON.stringify(selected_aliment_ids)
                    },
                    beforeSend:function(){
                         ceBouton.prop('disabled', true);
                         $('#loader').show();
                    },
                    success: function(response){

                        console.log(response);
                        ceBouton.prop('disabled', false);

                        if (response.statut == 1){
                            notifySuccess(response.message);

                            dataTable.search('').draw();
                            dataTable.draw();
                            $('#btnSelectAll').prop('checked', false);

                        }else{
                            notifyWarning(response.message);
                        }

                    },
                    error: function(){
                        notifyWarning("Erreur lors du traitement");
                        ceBouton.prop('disabled', false);
                        $('#loader').hide();
                    }

                });

            }else{
                notifyWarning("Veuillez sélectionner des prestataires");
            }

        });


    var my_noty;//variale global pour pouvoir le fermer de popup de l'extérieur
    function notifySuccess(message, fnCallback){
        my_noty = noty({
                text        : message,
                type        : 'success',
                dismissQueue: true,
                layout      : 'center',
                theme       : 'defaultTheme',
                buttons     : [
                    {addClass: 'btn btn-primary', text: 'OK', onClick: function ($noty) {

                        if (typeof fnCallback === 'function') fnCallback();

                        $noty.close();
                    }
                    }
                ]
            });
    }

    function notifyWarning(message, fnCallback){
          if (my_noty) {
            my_noty.close();
          }

        my_noty = noty({
                text        : message,
                type        : 'warning',
                dismissQueue: true,
                layout      : 'center',
                theme       : 'defaultTheme',
                buttons     : [
                    {addClass: 'btn btn-primary', text: 'OK', onClick: function ($noty) {

                        if (typeof fnCallback === 'function') fnCallback();

                        $noty.close();
                    }
                    }
                ]
            });

    }

    function notifyError(message, fnCallback){
        my_noty = noty({
                text        : message,
                type        : 'error',
                dismissQueue: true,
                layout      : 'center',
                theme       : 'defaultTheme',
                buttons     : [
                    {addClass: 'btn btn-primary', text: 'OK', onClick: function ($noty) {

                        if (typeof fnCallback === 'function') fnCallback();

                        $noty.close();
                    }
                    }
                ]
            });
    }


  });

// FIN GESTION TRANSFERT DE BENEFICIIRES
</script>

{% endblock %}