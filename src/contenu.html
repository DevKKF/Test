# Récupérer les assureurs associés à l'historique
assureur_police = PoliceAssureur.objects.filter(compagnie_id=compagnie_id, type_compagnie_id=1).first()

polices = Police.objects.filter(id=assureur_police.historique_police.police_id)

site_logo_url = request.build_absolute_uri(static(settings.JAZZMIN_SETTINGS['site_logo']))
print("Logo : ", site_logo_url)

'site_logo_url': site_logo_url,


TRUNCATE `aliment_police`; TRUNCATE `apporteurs_police`; TRUNCATE `autre_risque`; TRUNCATE `client_police`; TRUNCATE `historique_apporteurs_police`; TRUNCATE `historique_ordonnancement_sinistre`; TRUNCATE `autre_risque`;
TRUNCATE `historique_paiement_comptable_sinistre`; TRUNCATE `historique_polices`; TRUNCATE `historique_taxe_police`; TRUNCATE `mouvements_aliments`; TRUNCATE `mouvements_polices`;
TRUNCATE `mouvement_quittance`; TRUNCATE `police_assureurs`; TRUNCATE `police_garantie`; TRUNCATE `vehicules`; TRUNCATE `vehicule_police`; TRUNCATE `polices`; TRUNCATE `periode_couverture`;
TRUNCATE `quittances`; TRUNCATE `reglements`; TRUNCATE `reglement_compagnie`; TRUNCATE `reglement_facture_compagnie`; TRUNCATE `reglement_facture_compagnie`; TRUNCATE `historique_aliment`;


//********* FAIRE UN ENCAISSEMENT DE COMMISSION COURTAGE / GESTION ***********//

$(".btnOpenDialogDetailCompagnieEncaissementCourtGest").on('dblclick', function () {

    $(".btnOpenDialogDetailCompagnieEncaissementCourtGest").removeClass('tr_selected');
    $(this).addClass('tr_selected');
    let compagnie = $(this).data('compagnie');
    $("#datatable_stock_input_com").html("");
    $("#btnOpenDialogAddEncaissementCommisionCourtGest").trigger("click");

});


$("#btnOpenDialogAddEncaissementCommisionCourtGest").on('click', function () {

    let model_name = $(this).data('model_name');
    let modal_title = $(this).data('modal_title');
    let href = $(this).data('href');
    $("#datatable_stock_input_com").html("");

    $('#olea_std_dialog_box').load(href, function () {

        //appliquer le mask de saisie sur les champs montant
        AppliquerMaskSaisie();

        $('#modal-encaissement-court-gest').attr('data-backdrop', 'static').attr('data-keyboard', false);

        $('#modal-encaissement-court-gest').find('.modal-title').text(modal_title);
        $('#modal-encaissement-court-gest').find('#btn_valider').attr({ 'data-model_name': model_name, 'data-href': href });
        $('#modal-encaissement-court-gest').find('.modal-dialog').addClass('modal-xl').removeClass('modal-lg');

        //
        $('#modal-encaissement-court-gest').modal();

        $('#modal-encaissement-court-gest').on('shown.bs.modal', function () {
            compagnie = typeof $('.tr_selected') !== 'undefined' ? $('.tr_selected').data('compagnie') : "";
            if (compagnie && compagnie != "") {
                $('#modal-encaissement-court-gest #compagnie option[value=' + compagnie + ']').attr('selected', 'selected');
                $("#modal-encaissement-court-gest #compagnie").trigger('change');
            }
        })

        //gestion des saisies des montants à regler
        $(document).on('click', '.checkbox_quittance_a_encaisser_com_gest', function () {
            let input_montant_encaisse_court = $(this).closest('tr').find('.montant_encaisse_court');
            let input_montant_encaisse_gest = $(this).closest('tr').find('.montant_encaisse_gest');
            let solde_quittance = $(this).closest('tr').find('.solde_quittance').val();
            let input_solde_apres = $(this).closest('tr').find('.solde_apres');
            let montant_com_solde = parseFloat($(this).data('montant_com_solde'));
            let montant_com_courtage = 0; //parseFloat($(this).data('reglement_montant_com_courtage'));
            let montant_com_gestion = 0; //parseFloat($(this).data('reglement_montant_com_gestion'));
            let com_type = $("#com_type").val(); //le type de commision auquel on a affaire soit courtage ou gestion

            //input_montant_a_encaisser.val(0);
            input_solde_apres.val(solde_quittance);
            //$('#restant_total').val(montant_com_solde);
            if (com_type == "courtage") {
                $(this).closest('tr').find('.restant_total').val(parseFloat($(this).data('reglement_montant_com_courtage')));
            } else {
                $(this).closest('tr').find('.restant_total').val(parseFloat($(this).data('reglement_montant_com_gestion')));

            }

            if (this.checked) {
                if (com_type == "courtage") {
                    input_montant_encaisse_court.removeAttr('readonly');
                    input_montant_encaisse_court.attr('required', true);
                    input_montant_encaisse_court.val(0);//montant_com_courtage;
                } else {
                    input_montant_encaisse_gest.removeAttr('readonly');
                    input_montant_encaisse_gest.attr('required', true);
                    input_montant_encaisse_gest.val(0);//montant_com_gestion);
                }
                /// parade pour evider les doublons lors d'evenements
                already_exist = $("#datatable_stock_input_com").find("#input_stock_" + $(this).val());
                /// console.log(already_exist.length);
                if (already_exist.length == 0) {
                    /** parade pour eviter que lors du filtre des lignes la somme ne soient plus calculer correctement, pour cela creer des champs dynamique de stockage qui seront calculer en lieu et place des chechbox de base **/
                    $("#datatable_stock_input_com").append("<input type='text' class='input_stock' id='input_stock_" + $(this).val() + "' data-reglement_id='" + parseFloat($(this).data('reglement_id')) + "' data-reglement_montant='" + parseFloat($(this).data('reglement_montant')) + "'  data-reglement_montant_com_courtage='" + parseFloat($(this).data('reglement_montant_com_courtage')) + "'  data-reglement_montant_com_gestion='" + parseFloat($(this).data('reglement_montant_com_gestion')) + "' data-reglement_montant_compagnie='" + parseFloat($(this).data('reglement_montant_compagnie')) + "'>");
                }
            } else {
                if (com_type == "courtage") {
                    input_montant_encaisse_court.attr('readonly', true);
                    input_montant_encaisse_court.removeAttr('required');
                    input_montant_encaisse_court.val(0);
                } else {
                    input_montant_encaisse_gest.attr('readonly', true);
                    input_montant_encaisse_gest.removeAttr('required');
                    input_montant_encaisse_gest.val(0);
                }
                //console.log("a supprimer");
                $("#input_stock_" + $(this).val()).remove();
            }

            calculer_montant_total_a_encaisser_court_gest(com_type);


        });

        //montant_a_regler
        $(document).on('change keyup', '.handle_calculer_montant_total_a_encaisser', function () {
            let com_type = $("#com_type").val(); //le type de commision auquel on a affaire soit courtage ou gestion
            //console.log($(this).closest('tr').find('td:first-child input').val());
            $("#input_stock_" + $(this).closest('tr').find('td:first-child input').val()).val($(this).val());
            //console.log(com_type)
            //console.log('handle_calculer_montant_total_a_encaisser');
            calculer_montant_total_a_encaisser_court_gest(com_type);

        });

        $(document).on('change keyup', '#debit_difference', function () {
            $('#credit_difference').val("");
            //calculer_montant_total_a_encaisser();
        });
        $(document).on('change keyup', '#credit_difference', function () {
            $('#debit_difference').val("");
            //calculer_montant_total_a_encaisser();
        });

        $(document).on('change', '#modal-encaissement-court-gest #compagnie', function () {
            let href_reglements_reverses = $(this).children('option:selected').data('href_reglements_reverses');
            let com_type = $("#com_type").val(); //le type de commision auquel on a affaire soit courtage ou gestion
            //console.log(com_type)

            //reinitialisons les points important pour la commission
            $("#datatable_stock_input_com").html("");
            $('#credit_difference').val("");
            $('#debit_difference').val("");

            calculer_montant_total_a_encaisser_court_gest(com_type);//vider les champs d'aperçu

            $('.montant_total_com').val(0);

            $('#btn_save_encaissement').attr('disabled', 'true');

            $('#box_reglements_reverses').load(href_reglements_reverses, function () {
                $('#table_reglements_reverses').DataTable({
                    "language": {
                        "url": "../../static/admin_custom/js/French.json"
                    },
                    //order: [[0, 'desc']],
                    lengthMenu: [
                        [100, 250, 500, 1000, -1], [100, 250, 500, 1000, "Tout"]
                    ],
                    //sDom: "<'row'<'col-sm-6'>>t<'row'<'col-sm-6'><'col-sm-6'>>",
                    paging: false,
                    searching: true,
                    lengthChange: true,
                    bSort: false,
                    scrollX: true,
                });
            });

        });


        //champs obligatoires variables selon le mode de règlement
        $(document).on('change', '#mode_reglement', function () {
            //si espèce
            if ($(this).val() == 1) {
                $('#numero_piece').removeAttr('required');
                $('#banque').removeAttr('required');
                $('#libelle_numero_piece_required').html('');
                $('#libelle_banque_required').html('');
            } else {
                $('#numero_piece').attr('required', true);
                //$('#banque').attr('required', true);
                $('#libelle_numero_piece_required').html('*');
                //$('#libelle_banque_required').html('*');
            }

        });

        //enregistrement
        $('#btn_save_encaissement').on('click', function () {

            let btn_save_encaissement = $(this);

            let formulaire = $('#form_add_encaissement_commission');
            let href = formulaire.attr('action');

            $.validator.setDefaults({ ignore: [] });

            let com_type = $("#com_type").val(); //le type de commision auquel on a affaire soit courtage ou gestion

            if (formulaire.valid()) {

                //désactiver le bouton Valider, pour empecher une double soumission du formulaire
                btn_save_encaissement.attr('disabled', true);

                //demander confirmation
                let n = noty({
                    text: 'Voulez-vous vraiment effectuer cet encaissement ?',
                    type: 'warning',
                    dismissQueue: true,
                    layout: 'center',
                    theme: 'defaultTheme',
                    buttons: [
                        {
                            addClass: 'btn btn-primary', text: 'OUI', onClick: function ($noty) {
                                $noty.close();

                                //confirmation obtenu
                                $.ajax({
                                    type: 'post',
                                    url: href,
                                    data: formulaire.serialize(),
                                    success: function (response) {

                                        if (response.statut == 1) {

                                            notifySuccess(response.message, function () {

                                                $("#datatable_stock_input_com").html("");
                                                window.open('../generer_bordereau_encaissement_compagnie_pdf/' + response.data.operation_id + '?type=' + com_type, '_blank');

                                                //rediriger pour afficher le bordereau de reglement compagnie en pdf
                                                //console.log(response.data.pdf_url);
                                                //operation_id = response.data.operation_id;
                                                //console.log(operation_id);
                                                //location.href = 'comptabilite/generer_bordereau_encaissement_compagnie_pdf/'+operation_id;
                                                //window.open('comptabilite/generer_bordereau_encaissement_compagnie_pdf/'+operation_id);
                                                //location.href = 'comptabilite/generer_bordereau_encaissement_compagnie_pdf/'+operation_id;
                                                //alert(operation_id);
                                                //alert(location.href);

                                                location.reload();
                                            });


                                        } else {

                                            let errors = JSON.parse(JSON.stringify(response.errors));
                                            let errors_list_to_display = '';
                                            for (field in errors) {
                                                errors_list_to_display += '- ' + ucfirst(field) + ' : ' + errors[field] + '<br/>';
                                            }

                                            $('#modal-encaissement-court-gest .alert .message').html(errors_list_to_display);

                                            $('#modal-encaissement-court-gest .alert ').fadeTo(2000, 500).slideUp(500, function () {
                                                $(this).slideUp(500);
                                            }).removeClass('alert-success').addClass('alert-warning');

                                        }

                                    },
                                    error: function (request, status, error) {

                                        notifyWarning("Erreur lors de l'enregistrement");

                                        btn_save_encaissement.removeAttr('disabled');

                                    }

                                });

                                //fin confirmation obtenue

                            }
                        },
                        {
                            addClass: 'btn btn-danger', text: 'Annuler', onClick: function ($noty) {
                                //confirmation refusée
                                $noty.close();

                                btn_save_encaissement.removeAttr('disabled');

                            }
                        }
                    ]
                });
                //fin demande confirmation


            } else {

                $('label.error').css({ display: 'none', height: '0px' }).removeClass('error').text('');

                let validator = formulaire.validate();

                $.each(validator.errorMap, function (index, value) {

                    console.log('Id: ' + index + ' Message: ' + value);

                });

                notifyWarning('Veuillez renseigner tous les champs obligatoires');

                btn_save_encaissement.removeAttr('disabled');

            }


        });

    });

});


function calculer_montant_total_a_encaisser_court_gest(com_type) {

    let montant_total_reglements_coches = 0;
    let montant_total_a_regler_compagnie = 0;
    let montant_total_com_gestion = 0;
    let montant_total_com_courtage = 0;
    let montant_total_a_encaisser = 0;
    let montant_solde = 0;
    let difference_match = false;
    let erreur_difference = false
    // $('.montant_total_com').val(0);


    let credit_difference = $('#credit_difference').val().replaceAll(" ", "");
    credit_difference = credit_difference === "" || isNaN(credit_difference) ? 0 : parseFloat(credit_difference);
    let debit_difference = parseFloat($('#debit_difference').val().replaceAll(" ", ""));
    debit_difference = debit_difference === "" || isNaN(debit_difference) ? 0 : parseFloat(debit_difference);
    let text_compte_difference = $('#compte_difference option:selected').text();
    let is_perte_compte_difference = (text_compte_difference.indexOf("6511000") >= 0)
    console.log(is_perte_compte_difference);

    $('.input_stock').each(function (element) {

        let montant_reglement = parseFloat($("#input_stock_" + $(this).data('reglement_id')).data('reglement_montant'));
        let montant_compagnie = parseFloat($("#input_stock_" + $(this).data('reglement_id')).data('reglement_montant_compagnie'));
        if (com_type == "courtage") {
            let montant_com_courtage = parseFloat($("#input_stock_" + $(this).data('reglement_id')).data('reglement_montant_com_courtage'));
            let montant_a_encaisser_court = parseFloat($("#input_stock_" + $(this).data('reglement_id')).val().replaceAll(" ", ""));
            montant_a_encaisser_court = montant_a_encaisser_court === "" || isNaN(montant_a_encaisser_court) ? 0 : parseFloat(montant_a_encaisser_court);
            montant_total_com_courtage = montant_total_com_courtage + montant_a_encaisser_court;
            montant_total_a_encaisser = montant_total_com_courtage;
            difference = montant_com_courtage - montant_a_encaisser_court;
            if (montant_com_courtage < montant_a_encaisser_court) {
                erreur_difference = false; //true; car peut encaisser un montant superieur
            }
        }
        else {
            let montant_com_gestion = parseFloat($("#input_stock_" + $(this).data('reglement_id')).data('reglement_montant_com_gestion'));
            let montant_a_encaisser_gest = parseFloat($("#input_stock_" + $(this).data('reglement_id')).val().replaceAll(" ", ""));
            montant_a_encaisser_gest = montant_a_encaisser_gest === "" || isNaN(montant_a_encaisser_gest) ? 0 : parseFloat(montant_a_encaisser_gest);
            montant_total_com_gestion = montant_total_com_gestion + montant_a_encaisser_gest;
            montant_total_a_encaisser = montant_total_com_gestion;
            difference = montant_com_gestion - montant_a_encaisser_gest;
            if (montant_com_gestion < montant_a_encaisser_gest) {
                erreur_difference = false; //true; car peut encaisser un montant superieur
            }
        }

        let montant_a_encaisser = parseFloat($("#checkbox_quittance_a_encaisser_" + $(this).data('reglement_id')).closest('tr').find('.montant_a_encaisser').val());
        //montant_a_encaisser = montant_a_encaisser === "" ? 0 : parseFloat(montant_a_encaisser);


        montant_total_reglements_coches = montant_total_reglements_coches + montant_reglement;
        montant_total_a_regler_compagnie = montant_total_a_regler_compagnie + montant_compagnie;
        //montant_total_a_encaisser       = montant_total_a_encaisser + montant_a_encaisser;

        $("#checkbox_quittance_a_encaisser_" + $(this).data('reglement_id')).closest('tr').find('.restant_total').val(difference);

        if (debit_difference == difference && difference_match == false && difference > 0 && ((difference < 3000 && is_perte_compte_difference==true) || (is_perte_compte_difference==false))) {
            difference_match = true;
            if (debit_difference == difference && difference > 0) {
                $("#checkbox_quittance_a_encaisser_" + $(this).data('reglement_id')).closest('tr').find('.restant_total').val(difference - debit_difference);
                $("#checkbox_quittance_a_encaisser_" + $(this).data('reglement_id')).closest('tr').find('.handle_calculer_montant_total_a_encaisser').removeAttr('required');
            }
        }

        if (credit_difference == (-1 * difference) && difference_match == false && credit_difference > 0) {
            difference_match = true;
            if (credit_difference == (-1 * difference)) {
                $("#checkbox_quittance_a_encaisser_" + $(this).data('reglement_id')).closest('tr').find('.restant_total').val(difference + credit_difference);
                $("#checkbox_quittance_a_encaisser_" + $(this).data('reglement_id')).closest('tr').find('.handle_calculer_montant_total_a_encaisser').removeAttr('required');
            }
        }

        if (difference < 0) {
            erreur_difference = false; //true; car peut encaisser un montant superieur
        }

        montant_solde = montant_solde + difference;

        /*
        difference = montant_com_courtage-montant_a_encaisser_court+montant_com_gestion-montant_a_encaisser_gest
        if (difference > 0 && difference < 3000){
            $('#debit_difference').val(difference);
            $('#credit_difference').val("");
            $('#credit_difference').attr('readonly','true');
        }
        */

    });

    $('.montant_total_reglements_coches').val(montant_total_reglements_coches);
    $('.montant_total_a_regler_compagnie').val(montant_total_a_regler_compagnie);
    if (com_type == "courtage") {
        $('.montant_total_com_gestion').val(montant_total_com_gestion);
    } else {
        $('.montant_total_com_courtage').val(montant_total_com_courtage);
    }
    // $('.montant_total_com').val(montant_total_a_encaisser + credit_difference);
    $('.montant_total_com').val(montant_total_a_encaisser);

    if (montant_total_a_encaisser != 0 || (montant_total_a_encaisser == 0 && debit_difference > 0) || (montant_total_a_encaisser == 0 && credit_difference > 0)) {
        $('#btn_save_encaissement').removeAttr('disabled');
        console.log("enabled");
    } else {
        $('#btn_save_encaissement').attr('disabled', 'true');
        console.log("disabled 1");
    }

    if (((credit_difference > 0 || debit_difference > 0) && $('#compte_difference').val() == "")
        || (debit_difference > 3000 && is_perte_compte_difference==true)
        || (debit_difference > 0 && difference_match == false)
        || (credit_difference > 0 && difference_match == false)
        || ($('#compte_difference').val() != "" && debit_difference == 0 && credit_difference == 0)
        //|| (montant_solde > 0 && credit_difference > 0)
        || erreur_difference == true) {
        $('#btn_save_encaissement').attr('disabled', 'true');
        console.log("disabled 2");
    }

}


//********* FIN FAIRE UN ENCAISSEMENT COURTAGE / GESTION ***********//

