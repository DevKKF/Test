{% extends "admin/base_site.html" %}
{% load my_filters %}
{% block extrastyle %}

<style type="text/css">
    tr.tr_totaux td
    {
        border:1px solid #dee2e6;
    }

    tr.tr_totaux td .money_field
    {
        border:none;
        background:none;
        font-weight:bold;
        font-size:22px;
    }

    tr.tr_invisible td
    {
        border:0px solid red;
        padding:0px;
    }
    .varAlimentSinistreAutre{
        display:none;
    }
    div.dataTables_processing>div:last-child>div {
        background: rgb(187 65 38) !important;
    }
    /**/
    .search_by_benef_name {
        padding: 10px;
        background: linear-gradient(45deg, #F8AF3C, #F8AF3C);
        border-radius: 3px;
        font-weight: bold;
    }
    /**/
</style>
{% endblock %}
{% block content %}

<div class="col-12 col-md-12 order-2 order-md-1">
    <form id="form_add_sinistre_bygestionnaire" action="{% url 'add_sinistre_gestionnaire' %}" method="post">
      {% csrf_token %}

      <div class="card">
          <div class="card-header" style="background-color:var(--colorJauneOlea) important!">
              <h3 class="card-title"><b>{{_('INFORMATIONS_DU_BENEFICIAIRE')}}</b></h3>
              <div class="card-tools"></div>
          </div>

          <div class="card-body">

            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group row">
                            <label class="col-sm-6 col-form-label">{{_('Numero_de_carte')}} <span class="required">*</span></label>
                            <div class="col-sm-6">
                                <input type="text" autocomplete="off" class="form-control" name="numero_carte" id="numero_carte_gestionnaire" {% if prestataire_executant %} data-href_search_assure="{% url 'search_assure_bygestionnaire' prestataire_executant.id %}" data-href="{% url 'search_assure_bygestionnaire' prestataire_executant.id %}" {% endif %}  style="border:2px solid var(--colorJauneOlea);"/>
                            </div>
                        </div>
                    </div>
                    <!---->
                    <div class="col-md-3">
                        <span class="btn" data-toggle="modal" data-target="#modal_search_benef_by_name" style="background:gray;color:white;font-size:12px;"><i class="fa fa-search"></i> {{_('Recherche_par_nom')}}</span>
                    </div>
                    <!---->
                    <div class="col-md-5">
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">{{_('Date_de_soins')}} <span class="required">*</span></label>
                            <div class="col-sm-4">
                                <input type="date" autocomplete="off" class="form-control {% if prestataire_executant %} date_survenance_gestionnaire {% endif %}" name="date_survenance" id="date_survenance" max="{{ today|date:'Y-m-d' }}" required style="border:2px solid var(--colorJauneOlea);"/>
                            </div>
                            <div class="col-sm-3">
                                <input type="time" autocomplete="off" class="form-control" name="heure_survenance" id="heure_survenance" required style="border:2px solid var(--colorJauneOlea);" required/>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1" style="margin:0px;">
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <input type="hidden" class="form-control" name="current_searched_aliment_id" id="current_searched_aliment_id"/>

                                <!--input type="hidden" class="form-control" name="type_prise_en_charge" id="type_prise_en_charge" value="soins_ambulatoires"/>
                                <input type="hidden" class="form-control" name="type_prise_en_charge_code" id="type_prise_en_charge_code" value="AMBULAT"/>
                                <input type="hidden" class="form-control type_prise_en_charge_id" name="type_prise_en_charge_id" value="2"/-->

                                <span class="btn" {% if prestataire_executant %} id="btn_search_assure_gestionnaire" {% endif %}  style="background:gray;color:white;font-size:12px;" title="Rechercher"><i class="fa fa-search"></i> {{_('Rechercher')}}</span>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <div class="col-md-12">

                <div class="col-md-12 offset-0 varAlimentSinistreAutre" style="padding:0px;margin:0px;">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="">
                                <img style="width:100px;border-radius:5px;border:3px solid #dee2e6;" class="" id="photo" src=""/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">{{_('Nom')}} : </span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-nom"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">{{_('Prenoms')}} : </span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-prenoms"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">{{_('Date_naissance')}} : </span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-date_naissance"></span> (<span class="font-weight-normal" id="span-age"></span> ans)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">{{_('Statut')}} :</span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-qualite_beneficiaire"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">{{_('Type_de_contrat')}}</span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-formule"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">{{_('Couverture')}} : </span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-taux" style="color:#BB4127;font-weight:bold;"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;display:none;">
                                <span class="col-sm-4">{{_('Assureur')}} : </span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-assureur"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;display:none0;">
                                <span class="col-sm-4">{{_('Police')}} : </span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-police"></span>
                                </div>
                            </div>
                            <!--div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">Plafond famille</span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-plafond_consommation_famille"></span>
                                </div>
                            </div>
                            <div class="form-group row" style="margin-bottom:7px;">
                                <span class="col-sm-4">Plafond indiv.</span>
                                <div class="col-sm-8">
                                    <span class="font-weight-bold" id="span-plafond_consommation_individuelle"></span>
                                </div>
                            </div-->
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-12 offset-0 error_box_aliment_not_found text-center text-red" style="display:none;font-weight: bold;font-size: 30px;"></div>

          </div>

      </div>


      <div class="card ">
          <div class="card-header">
              <h3 class="card-title">
                  {{_('SAISIE_D_UNE_PRISE_EN_CHARGE')}}
              </h3>
              <div class="card-tools"><a style="cursor: pointer;color:white;" data-toggle="modal" data-target="#modal_choose_prestataire"><i class="fa fa-refresh"></i> {{_('Cliquez_pour_changer_de_prestataire')}} : <b>{{ prestataire_executant.name }}</a></b></div>
          </div>

          <div class="card-body varAlimentSinistreAutre__">

                <div class="modal-body" style="padding:0px;margin:0px;">
                    <div class="alert  alert-dismissible fade show hidden" role="alert">
                        <span class="message">{{_('TRAITEMENT_EN_COURS')}}</span>
                    </div>
                    <div class="col-md-12 offset-0">

                        <div class="row">
                            <div class="col-md-6">

                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="form-group row">
                                                <label class="col-sm-5 col-form-label">{{_('Prestataire_executant')}} <span class="required"></span></label>
                                                <div class="col-sm-7">
                                                    <!--select class="form-control tags-multiple " name="prestataire_executant" id="prestataire_executant_gestionnaire" required style="border:2px solid var(--colorJauneOlea);">
                                                        <option value="">Choisir</option>
                                                        {% for pe in prestataires %}
                                                        <option {% if pe.id == prestataire_executant.id %} selected {% endif %} value="{{ pe.id }}" data-type_prestataire_code="{{ pe.type_prestataire.code }}">{{ pe.name }}</option>
                                                        {% endfor %}
                                                    </select-->
                                                    <!--select class="form-control tags-multiple " name="prestataire_executant" id="prestataire_executant_gestionnaire" required style="border:none;">
                                                        <option selected value="{{ prestataire_executant.id }}" data-type_prestataire_code="{{ prestataire_executant.type_prestataire.code }}">{{ prestataire_executant.name }}</option>
                                                    </select-->
                                                    <input type="hidden" class="" name="prestataire_executant" id="prestataire_executant_gestionnaire" value="{{ prestataire_executant.id }}" required/>
                                                    <span class="form-control bold">{{ prestataire_executant.name }}</span>
                                                </div>
                                            </div>
                                            {% if prestataire_executant.type_prestataire.code != "PRES01" %}
                                            {% endif %}
                                            <div class="form-group row only_optique_labo_dentaire_imagerie">
                                                <label class="col-sm-5 col-form-label">{{_('Centre_prescripteur')}} <span class="required">*</span></label>
                                                <div class="col-sm-7">
                                                    <select class="form-control tags-multiple" name="centre_prescripteur" id="centre_prescripteur_gestionnaire" required>
                                                        <option value="">{{_('Choisir')}}</option>
                                                        {% for cp in centres_prescripteurs %}
                                                        <option {% if cp.id == prestataire_executant.id %} selected {% endif %} value="{{ cp.id }}">{{ cp.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-5 col-form-label">{{_('Medecin')}} <span class="required">*</span></label>
                                                <div class="col-sm-7">
                                                    <select class="form-control tags-multiple" name="prescripteur" id="prescripteur_gestionnaire" required>
                                                        <option value="">{{_('Choisir')}}</option>
                                                        {% for prescripteur in prescripteurs %}
                                                        <option value="{{ prescripteur.id }}">{{ prescripteur.nom }} {{ prescripteur.prenoms }} ({{ prescripteur.specialite|default_if_none:'' }})</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-5 col-form-label">{{_('Type_remboursement')}} <span class="required">*</span></label>
                                                <div class="col-sm-7">
                                                    <select class="form-control tags-multiple" name="type_remboursement" id="type_remboursement" required>
                                                        <option value="">{{_('Choisir')}}</option>
                                                        {% for type_remboursement in types_remboursements %}
                                                        <option value="{{ type_remboursement.id }}" data-code="{{ type_remboursement.code }}">{{ type_remboursement.libelle }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label class="col-sm-5 col-form-label">{{_('Soins_a_l_etranger')}} <span class="required">*</span></label>
                                                <div class="col-sm-7">
                                                    <select class="form-control tags-multiple" name="soins_a_l_entrange" id="soins_a_l_entrange" required>
                                                        <option value="0" selected>{{_('Non')}}</option>
                                                        <option value="1">{{_('Oui')}}</option>
                                                    </select>
                                                </div>
                                            </div>
                                            

                                            <div class="form-group row">
                                                <label class="col-sm-5 col-form-label">{{_('Reference_facture')}} <span class="required"></span></label>
                                                <div class="col-sm-7">
                                                    <input type="text" class="form-control" name="reference_facture" id="reference_facture" value="{{reference_facture_origin}}" readonly>
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label class="col-sm-5 col-form-label">{{_('Date_reception_facture')}} <span class="required"></span></label>
                                                <div class="col-sm-7">
                                                    <input type="date" class="form-control" name="date_reception_facture" id="date_reception_facture" max="{{ today|date:'Y-m-d' }}" value="{{date_reception_facture_origin}}" readonly>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            
                            <div class="vl"></div>
                            <div class="col-md-6" style="border-left:0px;margin-left:-5px;padding-left:15px;">

                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">{{_('Type_PEC')}} <span class="required">*</span></label>
                                    <div class="col-sm-8">
                                        <select class="form-control tags-multiple tags-multiple_actes_soins_ambulatoires" name="type_prise_en_charge_id" id="type_prise_en_charge_id" required>
                                            <option value="">{{_('Choisir')}}</option>
                                            {% for type_priseencharge in types_priseencharges %}
                                            <option value="{{ type_priseencharge.id }}">{{ type_priseencharge.libelle }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">{{_('Actes')}} <span class="required">*</span></label>
                                    <div class="col-sm-8">
                                        <select class="form-control acte_gestionnaire tags-multiple tags-multiple_actes_soins_ambulatoires" name="selected_actes[]" id="acte_gestionnaire" data-href_get_infos_selected_actes="{% url 'get_infos_selected_actes_gestionnaire' %}" required>
                                            <option value="">{{_('Veuillez_choisir_les_actes_a_exécuter_SVP')}} </option>
                                        </select>
                                        <input type="hidden" id="actes_du_tableau" name="actes_du_tableau">
                                    </div>
                                </div>

								<!--div class="form-group row only_hospit">
									<label class="col-sm-4 col-form-label">Coût de l'acte<span class="required"></span></label>
									<div class="col-sm-8">
										<input type="text" class="form-control money_field" name="cout_acte" id="cout_acte">
									</div>
								</div-->

                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">{{_('Affection')}} <span class="label_affection_required__plus_utilise required">*</span></label>
                                    <div class="col-sm-8">
                                        <select class="form-control tags-multiple tags-multiple tags-multiple_affection_id" name="affection" id="affection_id" >
                                            <option value="">{{_('Choisir')}}</option>
                                            {% for affection in affections %}
                                            <option value="{{ affection.id }}">{{ affection.code_cim_10 }} - {{ affection.libelle }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row" style="margin-top:-15px;display:none0;">
                                    <label class="col-sm-12 col-form-label">{{_('Renseignements_cliniques')}} <span class="required"></span></label>
                                    <div class="col-sm-12">
                                        <textarea class="form-control" name="renseignement_clinique_gestionnaire" id="renseignement_clinique_gestionnaire" rows="1"></textarea>
                                    </div>
                                </div>
                                <div class="form-group row" style="margin-top:-15px;display:none0;">
                                    <label class="col-sm-12 col-form-label">{{_('Commentaires')}} <span class="required"></span></label>
                                    <div class="col-sm-12">
                                        <textarea class="form-control" name="commentaire_gestionnaire" id="commentaire_gestionnaire" rows="1"></textarea>
                                    </div>
                                </div>
                                <!--div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Date de la prestation <span class="required">*</span></label>
                                    <div class="col-sm-8">
                                        <span type="text" class="form-control" style="background:#ddd;">{{ today|date:'d-m-Y' }}</span>
                                    </div>
                                </div-->

								<div class="form-group row only_hospit" style="display:none;">
									<div class="col-sm-4">
										<label class="col-sm-12 col-form-label">{{_('Nombre_de_jours')}} <span class="required">*</span></label>
										<div class="col-sm-12" class="form-control" style="text-align:right;font-weight:bold;">
											<input type="text" max="100" min="1" value="0" class="form-control money_field" name="nombre_jours" id="nombre_jours" readonly0 style="background:white;">
										</div>
									</div>
									<div class="col-sm-4">
										<label class="col-sm-12 col-form-label">{{_('Date_d_entree')}} <span class="required">*</span></label>
										<div class="col-sm-12">
											<input type="date" class="form-control not_resetable" value="{{ today|date:'Y-m-d' }}" name="date_entree" readonly_0 id="date_entree" required>
										</div>
									</div>
									<div class="col-sm-4">
										<label class="col-sm-12 col-form-label">{{_('Date_de_sortie')}} <span class="required">*</span></label>
										<div class="col-sm-12">
											<input type="date" class="form-control" name="date_sortie" id="date_sortie" readonly required>
										</div>
									</div>
								</div>


                            </div>
                            <div class="col-md-12 varAlimentSinistreAutre">
                                <div class="col-sm-12" id="loading_shimmer_box" style="display:none;">
                                    <article>
                                        <div class="line"></div>
                                        <div class="line"></div>
                                        <div class="line"></div>
                                        <div class="shimmer"></div>
                                    </article>
                                </div>
                                <div class="col-sm-12" style="padding-right:0px;padding:0px;" id="box_table_actes_selected">

                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <button type="reset" class="btn btn-default" data-dismiss="modal">{{_('Reinitialiser')}}</button>
                    <img src="" id="loading">
                    <button type="button" id="btn_save_sinistre_gestionnaire" class="btn o-bg-primary" disabled>{{_('Valider')}}</button>
                </div>
            <div class="form_sinistre_gestionnaire_overlay" id="form_sinistre_gestionnaire_overlay"><div style="margin:auto;padding:20px 0;color:white;text-align:center;">{{_('TRAITEMENT_EN_COURS')}} ...</div></div>

        </div>

      </div>


    </form>
</div>

{% endblock %}


{% block extrajs %}


<script>
    $(document).ready(function() {

        //Si un gestionnaire sinistre, cacher l'item liste-des-prises-en-charge
        {% if request.user.is_ges %}

        $('.nav-item_liste-des-prises-en-charge').hide();

        {% endif %}

        {% if not prestataire_executant %}
        $('#modal_choose_prestataire').modal();
        {% endif %}

        /*    
        $('#prestataire_executant_selected').change(function() {
            $('#loading_gif').show();

            var selectedPrestataireId = $(this).val();

            window.location.href = '/sinistre/saisie_prestation/' + selectedPrestataireId;
        });
        */

        $('#btn_confirm_selected_prestataire').click(function() {
            $('#loading_gif').show();

            var selectedPrestataireId = $('#prestataire_executant_selected').val();
            var referenceFacture = $('#reference_facture_origin').val();
            var dateReceptionFacture = $('#date_reception_facture_origin').val();

            //console.log(selectedPrestataireId + " " + referenceFacture + " " +dateReceptionFacture)

            // envoyons les données supplémentaires en paramètres GET
            window.location.href = '/sinistre/saisie_prestation/' + selectedPrestataireId + "?reference_facture=" + referenceFacture + "&date_reception_facture=" + dateReceptionFacture;
        });



        //
        //ADDED ON 14112023:

    // NOUVELLE VERSION SINISTRE GESTIONNAIRE
    $('#form_sinistre_gestionnaire_overlay').show();

    $(document).on('click', 'a[href="##saisie_prestation"]', function(){

        href = '/sinistre/popup_choose_prestataire';

        $('#olea_std_dialog_box').load(href, function(){

            $('#modal_choose_prestataire').attr('data-backdrop','static').attr('data-keyboard',false);

            $('#modal_choose_prestataire').find('.modal-dialog').addClass('modal-l').removeClass('modal-lg');

            if (typeof $.fn.select2 === 'function') {
                $('#prestataire_executant_selected').select2();
            }
            $('#modal_choose_prestataire').modal();

            /*
            $('#prestataire_executant_selected').change(function() {

                var selectedPrestataireId = $(this).val();

                window.location.href = '/sinistre/saisie_prestation/' + selectedPrestataireId;
            });
            */

        });

    });

    //Recherche d'un assuré
    $(document).on('keydown', '#numero_carte_gestionnaire', function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();

            performSearchAlimentByGestionnaire();
        }
    });

    $(document).on('click', '#btn_search_assure_gestionnaire', function(){
        performSearchAlimentByGestionnaire();
    });
    $(document).on('change', '.date_survenance_gestionnaire', function(){
        performSearchAlimentByGestionnaire();
    });

    function performSearchAlimentByGestionnaire(){

        let formulaire = $('#form_add_sinistre_bygestionnaire');

        let type_prise_en_charge_id = formulaire.find('#type_prise_en_charge_id').val();
        //alert(type_prise_en_charge_id);

        let date_survenance = formulaire.find('#date_survenance').val();
        let prestataire_id = formulaire.find('.prestataire_executant_id').val();
        let numero_carte = $('#numero_carte_gestionnaire').val();
        let href_search_assure = $('#numero_carte_gestionnaire').data('href_search_assure');

        //Added on 20112023:réinitialisée les champs
        formulaire.find('#date_entree').val(formulaire.find('#date_survenance').val());
        formulaire.find('#nombre_jours').val(0);
        formulaire.find('#date_sortie').val('');
        formulaire.find('#renseignement_clinique_gestionnaire').val('');
        formulaire.find('#commentaire_gestionnaire').val('');


        if(numero_carte == '' | date_survenance == ''){
            notifyWarning("Veuillez saisir le numéro de carte et la date de soin")
        }else{

            //
            formulaire.find('#actes_du_tableau').val('');
            formulaire.find('#box_table_actes_selected').html('');
            //REMPLIR avec ses actes garantis
            remplir_select_acte_gestionnaire(formulaire.find('#acte_gestionnaire'));

            //alert(date_survenance);

             $.ajax({
                type:'post',
                url:href_search_assure,
                data:{numero_carte:numero_carte, date_survenance:date_survenance, prestataire_id:prestataire_id, type_prise_en_charge_id:type_prise_en_charge_id},
                beforeSend: function(){
                     //$('.varAlimentSinistreAutre').hide();//Commented on 22112023
                },
                success: function(response){

                    if(response.statut == 1){

                       formulaire.find('.error_box_aliment_not_found').html("").hide();

                        hideAndEmptyOrShowSibblingByGestionnaire('varAlimentSinistreAutre', formulaire,'show');

                        let aliment = response.data;
                        formulaire.find('#current_searched_aliment_id').val(aliment.id);
                        formulaire.find('#span-nom').html(aliment.nom);
                        formulaire.find('#span-prenoms').html(aliment.prenoms);
                        formulaire.find('#span-date_naissance').html(aliment.date_naissance);
                        formulaire.find('#span-age').html(aliment.age);
                        formulaire.find('#photo').attr('src',aliment.photo);
                        formulaire.find('#span-assureur').html(aliment.nom_compagnie);
                        formulaire.find('#span-police').html(aliment.nom_client + ' (' + aliment.numero_police + ')');
                        formulaire.find('#span-taux').html(aliment.taux+" %");
                        formulaire.find('#span-qualite_beneficiaire').html(aliment.qualite_beneficiaire);
                        formulaire.find('#span-formule').html(aliment.formule);
                        formulaire.find('#span-plafond_chambre').html(aliment.plafond_chambre);
                        formulaire.find('#span-plafond_hospitalisation').html(aliment.plafond_hospitalisation);
                        formulaire.find('#span-plafond_consommation_famille').html(aliment.plafond_consommation_famille);
                        formulaire.find('#span-plafond_consommation_individuelle').html(aliment.plafond_consommation_individuelle);


                        //remplir la liste des actes garantis
                        let actes_garantis_json = aliment.actes_garantis;
                        actes_garantis_gestionnaire = JSON.parse(actes_garantis_json);

                        //REMPLIR avec ses actes garantis
                        remplir_select_acte_gestionnaire(formulaire.find('#acte_gestionnaire'));

                        //vérrouiller le champ de recherche de numero_assure
                        //formulaire.find('#numero_carte_gestionnaire').attr('readonly', 'readonly');

                        $('#form_sinistre_gestionnaire_overlay').hide();

                        //ajouter au formulaire de medicament
                        prestataire_id = $('#prestataire_executant_gestionnaire').val();
                        $('#modal_add_medicament #aliment_id').val(aliment.id);
                        $('#modal_add_medicament #prestataire_id').val(prestataire_id);


                    }else{
                        //notifyWarning(response.message);
                        formulaire.find('.error_box_aliment_not_found').html(response.message).show();

                        $('.varAlimentSinistreAutre').hide();

                        formulaire.find('#current_searched_aliment_id').val("");
                        formulaire.find('#span-nom').html("");
                        formulaire.find('#span-prenoms').html("");
                        formulaire.find('#span-date_naissance').html("");
                        formulaire.find('#span-age').html("");
                        formulaire.find('#photo').attr('src', "");
                        formulaire.find('#span-assureur').html("");
                        formulaire.find('#span-taux').html("");
                        formulaire.find('#span-qualite_beneficiaire').html("");
                        formulaire.find('#span-formule').html("");
                        formulaire.find('#span-plafond_chambre').html("");
                        formulaire.find('#span-plafond_hospitalisation').html("");
                        formulaire.find('#span-plafond_consommation_famille').html("");
                        formulaire.find('#span-plafond_consommation_individuelle').html("");

                    }

                },
                error:function(request, status, error){

                    //notifyWarning("Erreur lors de la recherche");
                    formulaire.find('.error_box_aliment_not_found').html("ERREUR LORS DE LA RECHERCHE").show();

                    $('.varAlimentSinistreAutre').hide();

                    formulaire.find('#current_searched_aliment_id').val("");
                    formulaire.find('#span-nom').html("");
                    formulaire.find('#span-prenoms').html("");
                    formulaire.find('#span-date_naissance').html("");
                    formulaire.find('#span-age').html("");
                    formulaire.find('#photo').attr('src', "");
                    formulaire.find('#span-assureur').html("");
                    formulaire.find('#span-taux').html("");
                    formulaire.find('#span-qualite_beneficiaire').html("");
                    formulaire.find('#span-formule').html("");
                    formulaire.find('#span-plafond_chambre').html("");
                    formulaire.find('#span-plafond_hospitalisation').html("");
                    formulaire.find('#span-plafond_consommation_famille').html("");
                    formulaire.find('#span-plafond_consommation_individuelle').html("");

                }

            });

        }
    }


    $( "#numero_carte_gestionnaire").on( "keydown", function() {
        let formulaire = $(this).closest('form');
        hideAndEmptyOrShowSibblingByGestionnaire('varAlimentSinistreAutre', formulaire,'hide');

        formulaire.find('.error_box_aliment_not_found').html("").hide();
    });

    function hideAndEmptyOrShowSibblingByGestionnaire(classDependance, form, etat){

        form.find("#current_searched_aliment_id").val("");
        $("."+classDependance+"").hide();
        $("."+classDependance+" input:not(.not_resetable)").val("");
        if(etat=="show"){
            $("."+classDependance+"").show();
        }
    }


    //au changement de prestataire executant, charger les medecins du centre sélectionné
    $(document).on("change", "#prestataire_executant_gestionnaire", function() {
        let formulaire = $(this).closest('form');

        prestataire_id = $(this).val();

        let selected_option = $(this).find("option:selected");
        let type_prestataire_code = selected_option.data("type_prestataire_code");


        //si un centre de soins,
        if (type_prestataire_code == "PRES01"){

            $('.only_optique_labo_dentaire_imagerie').hide();

            $.ajax({
                type: 'get',
                url: '/configurations/prescripteurs_by_prestataire/' + prestataire_id,
                dataType:'json',
                success: function(prescripteurs){
                    formulaire.find('#prescripteur_gestionnaire').html('').append('<option value="">Choisir</option>');

                    prescripteurs.forEach(function(prescripteur) {
                        formulaire.find('#prescripteur_gestionnaire').append('<option value="'+prescripteur.pk+'">'+prescripteur.fields.nom+' '+prescripteur.fields.prenoms+'</option>');
                    });
                },
                error: function(){
                    console.log('Erreur lors du chargement des prescripteurs du centre ');
                }
            });

        }else{
            $('.only_optique_labo_dentaire_imagerie').show();
        }



    });


    $(document).on("change", "#centre_prescripteur_gestionnaire", function() {
        prestataire_id = $(this).val();

        let selected_option = $(this).find("option:selected");
        let formulaire = $(this).closest('form');

        $.ajax({
            type: 'get',
            url: '/configurations/prescripteurs_by_prestataire/' + prestataire_id,
            dataType:'json',
            success: function(prescripteurs_gestionnaire){

                formulaire.find('#prescripteur_gestionnaire').html('').append('<option value="">Choisir</option>');

                prescripteurs_gestionnaire.forEach(function(prescripteur) {
                    formulaire.find('#prescripteur_gestionnaire').append('<option value="'+prescripteur.pk+'">'+prescripteur.fields.nom+' '+prescripteur.fields.prenoms+'</option>');
                });
            },
            error: function(){
                console.log('Erreur lors du chargement des prescripteurs du centre ');
            }
        });

    });

    //au changement d'acte- uniquement gestionnire
    $(document).on("change", "#acte_gestionnaire", function() {
        prestataire_id = $(this).val();

        let selected_option = $(this).find("option:selected");
        let type_pec = selected_option.data('type_pec');

        let formulaire = $(this).closest('form');



    });


    //soumission du formulaire de sinistre
    $(document).on("click", "#btn_save_sinistre_gestionnaire" , function(e) {
         e.preventDefault();

        let formulaire = $(this).closest('form');
        var type_prise_en_charge_id = formulaire.find(".type_prise_en_charge_id").val();

        if(formulaire.valid()){

            //vérifier s'il y a des coût de l'acte vide
            has_error_cout_acte = false;
            cpt_error = 0;
            let nombre_cout_acte = $('.cout_acte:not(.is_controle_non_facture)').length;
            if(nombre_cout_acte > 0){

                $('.cout_acte:not(.is_controle_non_facture)').each(function(element){
                    let valeur = $(this).val();
                    if(valeur == 0){
                        $(this).addClass('error');
                        has_error_cout_acte = true;
                        cpt_error ++;

                    }else{
                        $(this).removeClass('error');
                    }

                });

            }


            if (!has_error_cout_acte){

                 //demander confirmation
                 let n = noty({
                 text        : 'Voulez-vous vraiment enregistrer ?',
                 type        : 'warning',
                 dismissQueue: true,
                 layout      : 'center',
                 theme       : 'defaultTheme',
                 buttons     : [
                         {addClass: 'btn btn-primary', text: 'OUI', onClick: function ($noty) {
                             $noty.close();

                             //confirmation obtenu
                             $.ajax({
                                    type: 'POST',
                                    url: formulaire.attr('action'),
                                    data: formulaire.serialize(),
                                    beforeSend:function(){
                                        $('#form_sinistre_gestionnaire_overlay').show();
                                    },
                                    success: function(response) {
                                        $('#form_sinistre_gestionnaire_overlay').hide();
                                        notifySuccess(response.message);

                                        formulaire.find('#btn_save_sinistre_gestionnaire').attr('disabled',"disabled");


                                        //resetFieldsGestionnaire(formulaire);

                                        //
                                        performSearchAlimentByGestionnaire();

                                    },
                                    error: function(error) {
                                        $('#form_sinistre_gestionnaire_overlay').hide();
                                        notifyWarning("Erreur lors du traitement");
                                    }
                             });

                             if(type_prise_en_charge_id == 1){//CONSULTATION
                                //location.reload();
                             }

                             }
                         },
                         {addClass: 'btn btn-danger', text: 'Annuler', onClick: function ($noty) {
                             //confirmation refusée
                             $noty.close();

                         }
                         }
                     ]
                 });
                 //fin demande confirmation

            }else{
                let texte = (cpt_error > 1)? "le coût de chaque acte" : "le coût de l'acte";
                notifyWarning("Veuillez renseigner " + texte);
            }

        }else{
            notifyWarning("Veuillez renseigner correctement le formulaire");
        }

     });


    function is_specials_keys(keyCode){
        return (keyCode == 8 || keyCode == 9 || keyCode == 46 || keyCode == 37 || keyCode == 39);
    }

    $('#nombre_jours').on('blur', function(e) {//keydown keyup change
        // Récupérer le code de la touche pressée
        var keyCode = e.keyCode || e.which;
        console.log(keyCode);

            //faire le traitement
            let formulaire = $(this).closest('form');
            // Supprimer les caractères non numériques
            let input_value = $(this).val();
            var newValue = input_value.replace(/[^0-9]/g, '');
            //if (newValue > 5){newValue = 5;}
            $(this).val(newValue);
            console.log(newValue);

            //
            let nombre_jours = parseInt($(this).val());
            var date_entree = $('#date_entree').val();

            if (date_entree != '' && !isNaN(nombre_jours)) {
                var date1 = new Date(date_entree);
                date1.setHours(0, 0, 0, 0); // Définir l'heure à 00:00:00

                var date2 = new Date(date1.getTime());
                date2.setDate(date2.getDate() + nombre_jours);

                var year = date2.getFullYear();
                var month = date2.getMonth() + 1;
                var day = date2.getDate();

                var formattedDate = year + '-' + (month < 10 ? '0' : '') + month + '-' + (day < 10 ? '0' : '') + day;

                $('#date_sortie').val(formattedDate);
                console.log(formattedDate);

                //Si l'acte est renseigné :
                let acte_id = formulaire.find('.acte_prestation').val();
                //alert(acte_id);
                if(acte_id !=""){
                    // Simuler un onchange de acte pour que le calcul soit fait
                    formulaire.find('.acte_prestation').trigger('change');
                }

            }else{
                $('#date_sortie').val("");
            }


    });

    var xhr_change_acte_gestionnaire = '';
    //recherche de cout et tx franchise de l'acte
    $(document).on("change", "#acte_gestionnaire" , function() {

        let cet_element = $(this);
        let formulaire = $(this).closest('form');

        let type_prise_en_charge = formulaire.find('#type_prise_en_charge').val();
        let type_prise_en_charge_id = formulaire.find('#type_prise_en_charge_id').val();
        let type_prise_en_charge_code = formulaire.find('.type_prise_en_charge_code').val();


        //Added on 15112023: détecter le type de pec en fonction de l'acte sélectionné, permet d'utiliser le même formulaire pour tous les types de pec: consultation, soins ambulatoires, hospit.
        let selected_option = $(this).find("option:selected");
        let type_pec = selected_option.data("type_pec");
        if(type_pec == 'CONSULT'){
            type_prise_en_charge = 'consultation';
            type_prise_en_charge_id = 1;
            type_prise_en_charge_code = "CONSULT";

        }else if (type_pec == 'HOSPIT'){
            type_prise_en_charge = 'hospitalisation';
            type_prise_en_charge_id = 1;
            type_prise_en_charge_code = "HOSPIT";

        }else{
            type_prise_en_charge = 'soins_ambulatoires';
            type_prise_en_charge_id = 2;
            type_prise_en_charge_code = "AMBULAT";

        }
        //fin Added on 15112023:


        //Si hospit s'assurer que le nombre de jour est renseigné
        if(type_prise_en_charge_id == 3){
            let nombre_jours = parseInt(formulaire.find('#nombre_jours').val().replaceAll(' ',''));
            let cout_acte = parseInt(formulaire.find('#cout_acte').val().replaceAll(' ',''));
            if (isNaN(cout_acte)){
                cout_acte=parseInt(0);
            }

            //if (isNaN(cout_acte) || isNaN(nombre_jours) || cout_acte == 0 || nombre_jours == 0) return ;
            if (isNaN(cout_acte) || isNaN(nombre_jours) || nombre_jours == 0) return ;

            console.log("continue");
        }

        formulaire.find('#btn_save_sinistre_gestionnaire').attr('disabled',"disabled");
        formulaire.find('#box_table_actes_selected').hide();
        formulaire.find('#loading_shimmer_box').show();

        let href_get_infos_selected_actes = $(this).data('href_get_infos_selected_actes');

        //ajouter les lignes déjà dans le tableau
        let table_actes_sinistres_autre = formulaire.find('#table_actes_sinistres_autre');
        let str_actes_du_tableau = '';
        $('.selected_acte_info').each(function(){
            var acteId = $(this).data('acte_id');

            //added on 21062023: prendre en compte les quantié déjà renseignées, ou le montant pour optique et dentiste
            //fusionner les deux: acte_id:quantite:cout_acte
            var acteCout = $(this).closest('tr').find('.cout_acte').val();

            var acteQuantite = $(this).closest('tr').find('.nombre_seance').val();

            str_actes_du_tableau += acteId+':'+acteQuantite+':'+acteCout+',';

            //alert(str_actes_du_tableau);

        });
        $('#actes_du_tableau').val(str_actes_du_tableau);

        xhr_change_acte_gestionnaire = $.ajax({
            type: 'POST',
            url: href_get_infos_selected_actes,
            data: formulaire.serialize(),
            success: function(response){

                if(response.statut == 0){

                    notifyWarning(response.message);

                    formulaire.find('#loading_shimmer_box').hide();

                    //si consultation, cacher le tableau des actes
                    if(type_prise_en_charge_id == 1 ){
                        formulaire.find('#box_table_actes_selected').hide();
                    }else{
                        formulaire.find('#box_table_actes_selected').show();
                    }

                    //alert(type_prise_en_charge_id);


                }else{

                    formulaire.find('#box_table_actes_selected').html(response);

                    //appliquer le mask de saisie sur les champs montant
                    AppliquerMaskSaisieGestionnaire();
                    //alert("exec AppliquerMaskSaisieGestionnaire");



                    formulaire.find('#btn_save_sinistre_gestionnaire').removeAttr('disabled');

                    formulaire.find('#box_table_actes_selected').show();
                    formulaire.find('#loading_shimmer_box').hide();

                    //alert(type_prise_en_charge_id);
                    //Added on 23052023::si soins ambulatoire : rafraichir la liste en supprimant celle qui vient d'etre ajouté
                    if(type_prise_en_charge_id != 1 && type_prise_en_charge_id != 3){
                        remplir_select_acte_gestionnaire(cet_element);

                        //désactiver le require du champ select
                        $('#acte_gestionnaire').removeAttr('required');
                    }

                    //scroller la liste pour aller en bas:: ne marche pas pour l'instant
                    let scrollableDiv = formulaire.find('#box_table_actes_selected');
                    scrollableDiv.scrollTop = scrollableDiv[0].scrollHeight - scrollableDiv.height();

                }

            },
            error:function(){

                notifyError("Erreur lors du chargement");

                formulaire.find('#box_table_actes_selected').show();
                formulaire.find('#loading_shimmer_box').hide();
            }
        });

    });

    //Pendant la saisie des coûts des actes, désactiver le bouton valider pour l'activer après le calcul
    $(document).on("keydown", ".cout_acte" , function() {
        //vérifier si la valeur a changé avant de recalculer
        var new_cout_acte = parseInt($(this).val().replaceAll(' ',''));
        var old_cout_acte = parseInt($(this).closest('tr').find('.selected_acte_info').data('frais_reel'));

        //en cas de changement de valeur simuler un onchange de acte pour que le calcul soit fait
        if(new_cout_acte != old_cout_acte){
            $('#btn_save_sinistre_gestionnaire').attr('disabled', true);
        }
    });

    //Pour optique et dentaire, au changement de cout_acte sur chaque ligne
    $(document).on("blur", ".cout_acte" , function() {
        let formulaire = $(this).closest('form');

        //vérifier si la valeur a changé avant de recalculer
        var new_cout_acte = parseInt($(this).val().replaceAll(' ',''));
        var old_cout_acte = parseInt($(this).closest('tr').find('.selected_acte_info').data('frais_reel'));


        //en cas de changement de valeur simuler un onchange de acte pour que le calcul soit fait
        if(new_cout_acte != old_cout_acte){
            formulaire.find('#acte_gestionnaire').trigger('change');
        }

    });

    //Pour soins ambulatoire, au changement de nombre_seance sur chaque ligne
    $(document).on("blur", ".nombre_seance" , function() {
        let formulaire = $(this).closest('form');
        //simuler un onchange de acte pour que le calcul soit fait
        formulaire.find('#acte_gestionnaire').trigger('change');
    });

    //pour hospit, rechercher au changement du montant
    $(document).on("blur", "#cout_acte" , function() {
        let formulaire = $(this).closest('form');
        //simuler un onchange de acte pour que le calcul soit fait
        formulaire.find('#acte_gestionnaire').trigger('change');
    });

    //Added on 06102023: désactiver ce fonctionnement - Lionel et Dr Amien
    //si affection renseigné désactiver required sur renseignement clinique
    /*$(document).on("change", "#affection_id" , function() {
        let formulaire = $(this).closest('form');

        let affection_id = $(this).val();
        let renseignement_clinique_gestionnaire = formulaire.find('#renseignement_clinique_gestionnaire').val();

        if(affection_id != ""){
            formulaire.find('.renseignement_clinique_gestionnaire').removeAttr('required');
            formulaire.find('.label_renseignement_clinique_required').text('');
        }else{
            formulaire.find('.renseignement_clinique_gestionnaire').attr('required', 'true');
            formulaire.find('.label_renseignement_clinique_required').text('*');
        }

    });

    //si affection renseigné désactiver required sur renseignement clinique
    $(document).on("keyup", "#renseignement_clinique_gestionnaire" , function() {
        let formulaire = $(this).closest('form');

        let affection_id = $(this).val();
        let renseignement_clinique_gestionnaire = formulaire.find('#renseignement_clinique_gestionnaire').val();

        if(renseignement_clinique_gestionnaire.length >= 3){
            formulaire.find('#affection_id').removeAttr('required');
            formulaire.find('.label_affection_required').text('');
        }else{
            formulaire.find('#affection_id').attr('required', 'true');
            formulaire.find('.label_affection_required').text('*');
        }

    });
    */

    $(document).on("change", "#type_prise_en_charge_id" , function() {
        let formulaire = $(this).closest('form');
        let type_prise_en_charge_id = $(this).val();

        if (type_prise_en_charge_id != ''){

            if(type_prise_en_charge_id == 1){
                $('.only_hospit').hide();

            }else if (type_prise_en_charge_id == 3){//type_pec == 'HOSPIT'
                //Afficher les champs propres à hospit
                $('.only_hospit').show();

            }else{
                $('.only_hospit').hide();

            }

            performSearchAlimentByGestionnaire(type_prise_en_charge_id);

        }

    });


    var actes_garantis_gestionnaire = '';

    function remplir_select_acte_gestionnaire(select_acte_gestionnaire){

       //récupérer les actes à exclure
       let actes_exclus = [];
       $('.selected_acte_info').each(function(){
            actes_exclus.push($(this).val());

       });

       select_acte_gestionnaire.empty();
       let option = $('<option>').val("").text("Choisir");
       select_acte_gestionnaire.append(option);

       $.each(actes_garantis_gestionnaire, function(index, acte) {

            if (!actes_exclus.includes(acte.id.toString())) {
                let option = $('<option>').val(acte.id).text(acte.libelle).data('type_pec',acte.rubrique__type_priseencharge__code);
                select_acte_gestionnaire.append(option);
            }

       });

    }

    //Suppression d'un élément du tableau - cas ambulatoire
    $(document).on("click", ".btnSupprimerLigneActeGestionnaire" , function(e) {
        let ligne_acte = $(this).closest('tr');
        let select_acte_gestionnaire = $(this).closest('form').find('#acte_gestionnaire');

        //demander confirmation
         let n = noty({
         text        : 'Voulez-vous vraiment supprimer cette ligne ?',
         type        : 'warning',
         dismissQueue: true,
         layout      : 'center',
         theme       : 'defaultTheme',
         buttons     : [
                 {addClass: 'btn btn-primary', text: 'OUI', onClick: function ($noty) {
                     $noty.close();


                        //confirmation obtenu
                        ligne_acte.remove();
                        //remplir le champs tableau_
                        //ajouter les lignes déjà dans le tableau
                        let str_actes_du_tableau = '';
                        $('.selected_acte_info').each(function(){
                            var acteId = $(this).data('acte_id');
                            str_actes_du_tableau += acteId+',';
                        });
                        $('#actes_du_tableau').val(str_actes_du_tableau);

                        remplir_select_acte_gestionnaire(select_acte_prestation);

                        //calculer
                        //calculer_total_actes_gestionnaire();

                        let formulaire = $(this).closest('form');
                        //simuler un onchange de acte pour que le calcul soit fait
                        //formulaire.find('#acte_gestionnaire').trigger('change').hide();

                        select_acte_gestionnaire.trigger('change');
                        //alert("trigger");

                     }
                 },
                 {addClass: 'btn btn-danger', text: 'Annuler', onClick: function ($noty) {
                     //confirmation refusée
                     $noty.close();

                 }
                 }
             ]
         });
         //fin demande confirmation

    });


    function calculer_total_actes_gestionnaire() {
      let total_frais_reel = 0;
      let total_part_compagnie = 0;
      let total_part_assure = 0;
      let cpt = 0;

      var formulaire = $(this).closest('form');
      var type_prise_en_charge_id = formulaire.find("#type_prise_en_charge_id").val();

      $('.selected_acte_info').each(function() {
        let ligne_acte = $(this).closest('tr');

        let nombre_seance = parseInt(ligne_acte.find('.nombre_seance').val());

        let frais_reel = 0;
        if(isNaN(nombre_seance)){
            let cout_acte = parseInt(ligne_acte.find('.cout_acte').val());
            //alert(cout_actes);

            frais_reel = cout_acte;
        }else{
            frais_reel = parseInt($(this).data('frais_reel'));
        }


        var part_compagnie = parseInt($(this).data('part_compagnie'));
        var part_assure = parseInt($(this).data('part_assure'));

        total_frais_reel += isNaN(frais_reel) ? 0 : frais_reel * nombre_seance;
        total_part_compagnie += isNaN(part_compagnie) ? 0 : part_compagnie * nombre_seance;
        total_part_assure += isNaN(part_assure) ? 0 : part_assure * nombre_seance;

        cpt++;

      });

      $('#total_frais_reel').text(total_frais_reel);
      $('#total_part_compagnie').text(total_part_compagnie);
      $('#total_part_assure').text(total_part_assure);

      // cacher le tableau si aucune donnée restante
      if (cpt === 0) {
        $('#box_table_actes_selected').hide();
        $('.acte_prestation').attr('required', 'true');
      }
    }



    //

    //afficher le détail d'un sinistre
    $(document).on("click", ".btn-popup_add_medicament_session_gestionnaire" , function(e) {
        e.preventDefault();

        let href = $(this).data('href');
        let date_survenance = $('#date_survenance').val();

        $('#olea_std_dialog_box').load(href, function(){

            $('#modal_add_medicament').attr('data-backdrop','static').attr('data-keyboard',false);

            $('#modal_add_medicament').find('.modal-dialog').addClass('modal-xl').removeClass('modal-lg');

            //appliquer datatable
            $('#table_medicaments_session_gestionnaire').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/French.json"
                },
                order: [[0, 'asc']],
                paging: false,
                searching:false,
                lengthChange: false,
            });

            //
            $('#modal_add_medicament').modal();
            $('#date_survenance_medicament').val(date_survenance);

        });


    });


    //Ajout du médicament
    $(document).on("click", "#btn_save_medicament" , function(e) {

        let formulaire = $('#form_add_medicament');
        if(formulaire.valid()){

        $.ajax({
                type: 'POST',
                url: formulaire.attr('action'),
                data: formulaire.serialize(),
                success: function(response) {

                    //notifySuccess(response.message);

                    $('#quantite').val("1");
                    $('#prix_unitaire').val("0");
                    //$('#medicament_id').prop('selectedIndex',0);
                    $('#medicament_id').val(null).trigger('change');


                    //table_medicaments
                    medicament = response.data;
                    let t = $('#table_medicaments_session_gestionnaire').DataTable();

                    t.row.add([
                                medicament.libelle,
                                '<span style="text-align:right"display:block;>'+medicament.taux_couverture + ' %</span>',
                                medicament.qte_servie,
                                medicament.prix_unitaire,
                                medicament.prix_total,
                                medicament.part_assureur,
                                medicament.depassement,
                                medicament.part_assure,
                                medicament.actions_html,
                                ])
                                .draw(false);

                },
                error: function(error) {
                    notifyWarning("Erreur lors du traitement");
                }
         });

        }else{
            notifyWarning("Veuillez renseigner correctement le formulaire");
        }

    });


    //Suppression d'un médicament de la session
    $(document).on("click", ".btnSupprimerLigneMedicamentGestionnaire" , function(e) {
        let ligne_acte = $(this).closest('tr');
        let href = $(this).data('href');
        //let medicament_id = $(this).data('medicament_id');
        let medicamentLibelle = ligne_acte.find('td:first').text();

        $.ajax({
            type:'post',
            url:href,
            success: function(response){
                    ligne_acte.remove();

                let t = $('#table_medicaments_session_gestionnaire').DataTable();

                // Trouver la ligne correspondante dans le DataTable et la supprimer
                t.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    let rowData = this.data();
                    if (rowData[0] === medicamentLibelle) {
                        this.remove().draw(false);
                        return false; // Sortir de la boucle après la suppression
                    }
                    return true; // Continuer à parcourir les lignes
                });


            },
            error: function(){
                notifyWarning("Erreur lors de la suppression");
            }
        });
    });


    //FIN NOUVELLE VERSION SINISTRE GESTIONNAIRE


function resetFieldsGestionnaire(formulaire){

    $(formulaire + " input:not(.notreset)").val("");
    $(formulaire + " input[type=number]:not(.notreset)").val("");
    $(formulaire + " input[type=date]:not(.notreset)").val("");
    $(formulaire + " input[type=email]:not(.notreset)").val("");
    $(formulaire + " select:not(.notreset)").prop('selectedIndex',0);

}

function AppliquerMaskSaisieGestionnaire(){

	//appliquer le mask de saisie sur les champs montant
	Inputmask("currency", {
		prefix: "",
		groupSeparator: " ",//désactiver pour
		alias: "numeric",
		digits: 0,// nombre de caractère après la virgule
        onKeyDown: function(event) {
            var key = event.keyCode || event.charCode;

            // Empêcher la saisie du signe négatif
            if (key === 189 || key === 109) { // Les codes 189 et 109 correspondent au signe moins (-)
                event.preventDefault();
                return false;
            }
        }	
	}).mask('.money_field');

    Inputmask("currency", {
		prefix: "",
		groupSeparator: " ",//désactiver pour
		alias: "numeric",
		digits: 0,// nombre de caractère après la virgule
        onKeyDown: function(event) {
            var key = event.keyCode || event.charCode;

            // Empêcher la saisie du signe négatif
            if (key === 189 || key === 109) { // Les codes 189 et 109 correspondent au signe moins (-)
                event.preventDefault();
                return false;
            }
        }	
	}).mask('.total_autres_taxes');


    /*
    new Cleave('.money_field', {
        numeral: true,
        numeralThousandsGroupStyle: 'thousand'
        //delimiter: ' ',
    });
    alert("cleve init");


    if ($('.money_field').length > 0) {

       AutoNumeric.multiple('.money_field', {
          currencySymbol: '',
          digitGroupSeparator: ' ',
          decimalCharacter: '.',
          decimalPlaces: 0
        });

    }
    */

}
AppliquerMaskSaisieGestionnaire();



var my_noty;//variale global pour pouvoir le fermer de popup de l'extérieur
function notifySuccess(message, fnCallback){
    my_noty = noty({
            text        : message,
            type        : 'success',
            dismissQueue: true,
            layout      : 'center',
            theme       : 'defaultTheme',
            buttons     : [
                {addClass: 'btn btn-primary', text: 'OK', onClick: function ($noty) {

                    if (typeof fnCallback === 'function') fnCallback();

                    $noty.close();
                }
                }
            ]
        });
}

function notifyWarning(message, fnCallback){
      if (my_noty) {
        my_noty.close();
      }

    my_noty = noty({
            text        : message,
            type        : 'warning',
            dismissQueue: true,
            layout      : 'center',
            theme       : 'defaultTheme',
            buttons     : [
                {addClass: 'btn btn-primary', text: 'OK', onClick: function ($noty) {

                    if (typeof fnCallback === 'function') fnCallback();

                    $noty.close();
                }
                }
            ]
        });

}

function notifyError(message, fnCallback){
    my_noty = noty({
            text        : message,
            type        : 'error',
            dismissQueue: true,
            layout      : 'center',
            theme       : 'defaultTheme',
            buttons     : [
                {addClass: 'btn btn-primary', text: 'OK', onClick: function ($noty) {

                    if (typeof fnCallback === 'function') fnCallback();

                    $noty.close();
                }
                }
            ]
        });
}


/* */
    $(document).on("click", ".btn_select_beneficiaire", function(e) {
        console.log('button btn_select_beneficiaire is clicked.');

        e.preventDefault();
        var numero_carte = $(this).data('numero_carte');
        console.log('Selected numero_carte:', numero_carte);

        // Close the modal
        $('#modal_search_benef_by_name').modal('hide');

        // Populate the numero_carte field in form_saisie_prestation_gestionnaires.html
        $('#numero_carte_gestionnaire').val(numero_carte);

    });
/**/

});


</script>



<script>
    document.addEventListener("DOMContentLoaded", function() {
        const typeRemboursementSelect = document.getElementById('type_remboursement');
    
        // Assuming you have a hidden input or some variable to determine the type of reimbursement
        const reimbursementType = "TP"; //RD This should be dynamically set based on your application logic
        /*
        if (reimbursementType === "RD") {
            // Select "Remboursement direct"
            for (let option of typeRemboursementSelect.options) {
                if (option.dataset.code === "RD") {
                    option.selected = true;
                    break;
                }
            }
        } else if (reimbursementType === "TP") {
            // Select "Tier Payant"
            for (let option of typeRemboursementSelect.options) {
                if (option.dataset.code === "TP") {
                    option.selected = true;
                    break;
                }
            }
        }
        */
    });
    </script>

{% include 'modal_choose_prestataire.html' %}
{% include 'modal_search_benef_by_name.html' %}

{% endblock %}
